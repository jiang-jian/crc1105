# 外置读卡器使用指南

## 🎯 已修复的功能

✅ **自动权限管理** - 扫描到设备后自动请求USB权限  
✅ **调试日志面板** - 右下角可展开查看详细日志  
✅ **智能错误提示** - 根据错误类型给出解决建议  
✅ **自动读卡** - 权限授予后自动启动读卡监听  
✅ **多方式读取** - 支持3种UID读取方式，自动切换  

---

## 🔧 调试日志面板使用

### 位置与操作
- **位置**: 页面右下角浮动面板
- **展开**: 点击 ▼ 图标
- **收起**: 点击 ▲ 图标
- **清空**: 点击 🗑️ 图标

### 日志颜色含义
- 🟢 **绿色** (✓): 操作成功
- 🔴 **红色** (✗): 操作失败
- 🟠 **橙色** (⚠): 警告信息
- ⚪ **白色**: 普通信息

---

## 🔍 常见问题快速解决

### 问题1: 未检测到读卡器

**检查清单**:
1. ✓ USB线插好，读卡器指示灯亮起
2. ✓ 点击"刷新设备"按钮
3. ✓ 尝试重新插拔USB
4. ✓ 更换USB接口（避免USB Hub）

**查看日志**:
```
期望看到: "检测到 1 个读卡器"
如果是0: 检查物理连接或设备兼容性
```

---

### 问题2: 检测到设备但无法读卡

**步骤1: 检查权限**
- 日志中查找 "✓ USB权限已授予"
- 如果显示 "✗ USB权限被拒绝":
  1. 点击"刷新设备"
  2. 在弹窗中选择"允许"
  3. 勾选"始终允许"

**步骤2: 检查自动读卡**
- 日志中查找 "启动自动读卡监听"
- 应该有周期性的读卡尝试

**步骤3: 放置卡片**
- 卡片完全平放在读卡器上
- 保持3秒不动
- 观察日志变化

---

### 问题3: 读到卡但UID显示Unknown

**日志分析**:
```
查找这些关键信息:
1. "ATR数据: XXXXXXXX" - 卡片基本信息
2. "尝试方式1/2/3" - 查看哪种方式成功
3. "UID验证" - 是否通过验证
```

**常见原因**:
- **UID全为0**: 卡片未正确放置或空卡
- **方式1、2失败**: 尝试调整卡片位置
- **所有方式失败**: 卡片类型可能不支持

**解决方案**:
1. 重新放置卡片
2. 使用其他已知好卡测试
3. 查看完整日志确定具体原因

---

## 📊 日志关键信息解读

### 成功流程示例
```
========== 开始扫描USB读卡器 ==========
✓ 检测到 1 个读卡器
✓ 已选择设备: ACR122U
设备未授权，正在请求USB权限...
[用户点击"允许"]
✓ USB权限已授予
✓ 设备已授权，准备启动自动读卡
启动自动读卡监听
[放置卡片]
✓ 检测到新卡片
  UID: 04:A1:B2:C3
  类型: Mifare Classic 1K
```

### 失败时查找的信息

#### 连接失败
```
✗ 无法打开设备连接
→ 原因: 权限问题或设备被占用
→ 解决: 重新授权或重启应用
```

#### 接口失败
```
✗ 未找到CCID接口
设备接口数: X
→ 原因: 设备类型不兼容
→ 解决: 确认是否为标准CCID读卡器
```

#### 读卡失败
```
✗ 未收到ATR数据
→ 原因: 无卡片或卡片未正确放置
→ 解决: 重新放置卡片
```

---

## 🎯 最佳实践

### 首次使用
1. 插入读卡器，等待5秒
2. 点击"刷新设备"
3. 在权限对话框选择"允许" + "始终允许"
4. 使用已知好卡测试
5. 观察日志确认一切正常

### 日常使用技巧
- 保持日志面板展开，方便观察
- 卡片完全平放，保持稳定
- 遇到问题先看日志再操作
- 不要频繁插拔USB

### 性能建议
- 读卡器放在固定位置
- 避免多个应用同时使用
- 定期清理日志（避免内存占用）

---

## 📞 需要帮助时提供的信息

1. **设备信息** (从日志中复制)
   - 厂商ID: 0xXXXX
   - 产品ID: 0xXXXX
   - 型号名称

2. **完整日志**
   - 从扫描到失败的完整过程
   - 最好截图

3. **问题描述**
   - 具体的错误提示
   - 已尝试的解决方案

---

## 🔬 技术细节

### UID读取的3种方式

**方式1: 标准命令** (推荐)
```
命令: FF CA 00 00 00
优点: 兼容性好，速度快
缺点: 少数读卡器不支持
```

**方式2: Mifare Block 0**
```
命令: FF B0 00 00 10
优点: 可读取完整块数据
缺点: 需要认证（使用默认密钥）
```

**方式3: ATR提取**
```
功能: 从历史字节中提取
优点: 不需要额外命令
缺点: UID可能不完整
```

系统会自动尝试这3种方式，选择第一个成功的。

---

**版本**: 1.0  
**日期**: 2024-01-20
